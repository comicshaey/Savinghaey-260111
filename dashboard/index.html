<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>마감 임박 업무 목록</title>

  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    :root{
      --line:#e5e5e5;
      --muted:#666;
      --chip:#f3f4f6;
      --danger:#c8352d;
      --warn:#b45309;
      --ok:#0f766e;
      --late:#7c3aed;
    }

    body.page-deadline h1{
      text-align:left !important;
      margin: 18px 0 8px;
      font-size: 1.75rem;
    }

    body.page-deadline .subtitle{margin:0 0 12px; color:#444; font-size:0.98rem}

    body.page-deadline .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    body.page-deadline .topbar .left{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    body.page-deadline .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid #e6e6e6;
      font-size:0.9rem;
      color:#333;
    }
    body.page-deadline .pill b{color:#111}

    body.page-deadline .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    body.page-deadline .controls input[type="date"]{min-width:160px;}
    body.page-deadline .controls select{min-width:160px;}

    body.page-deadline .chip.due-danger{border-color:rgba(200,53,45,.35); color:var(--danger); font-weight:800;}
    body.page-deadline .chip.due-warn{border-color:rgba(180,83,9,.35); color:var(--warn); font-weight:800;}
    body.page-deadline .chip.due-ok{border-color:rgba(15,118,110,.35); color:var(--ok); font-weight:800;}
    body.page-deadline .chip.due-late{border-color:rgba(124,58,237,.35); color:var(--late); font-weight:800;}

    body.page-deadline footer{
      margin:18px 0 8px;
      color:#555;
      font-size:.9rem;
      text-align:center;
    }

    /* 지난 업무 details */
    body.page-deadline .details-box{ margin-top:14px; }
    body.page-deadline .details-box summary{
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:#222;
      padding:8px 10px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid #e5e5e5;
      list-style:none;
    }
    body.page-deadline .details-box summary::-webkit-details-marker{display:none;}
    body.page-deadline .details-box[open] summary{ background:#fff; }

    body.page-deadline .details-hint{
      font-weight:600;
      font-size:0.95rem;
      color:#666;
    }

    /* 더보기 영역 */
    body.page-deadline .more-row{
      display:flex;
      justify-content:center;
      margin-top:12px;
    }
    body.page-deadline .btn.more{
      border-color:#d1d5db;
      background:#f9fafb;
      font-weight:700;
    }
    body.page-deadline .btn.more:hover{
      background:#eef2ff;
    }
  </style>
</head>

<body class="page-deadline">
  <main class="wrap">
    <h1>마감임박 업무 알림</h1>
    <p class="subtitle">·마감 넘긴 것도 같이 조회</p>

    <div class="topbar">
      <div class="left">
        <span class="pill">기준 일자: <b id="baseLabel">-</b></span>
        <span class="pill">파일 로딩: <b id="filesLabel">-</b></span>
      </div>
      <div>
        <a class="btn" href="/">메인으로 돌아가기</a>
        <a class="btn" href="/calendar/">달력 보기</a>
      </div>
    </div>

    <div class="section">
      <div class="controls">
        <label class="muted">기준 일자:
          <input type="date" id="baseDateInput" />
        </label>

        <label class="muted">조회 범위:
          <select id="rangeSel">
            <option value="0">전체보기</option>
            <option value="1">당일</option>
            <option value="7" selected>7일</option>
            <option value="14">14일</option>
          </select>
        </label>

        <button class="btn primary" id="reloadBtn" type="button">조회하기</button>
      </div>
      <p class="muted" style="margin:10px 0 0;">
        기준일자 전후로 보여줌
      </p>
    </div>

    <section class="section">
      <h2 style="font-size:1.2rem; margin:0 0 12px">마감 임박 업무 목록</h2>
      <hr />

      <div class="muted" style="margin:0 0 8px;">당일~이후 마감 업무</div>
      <div id="rootUpcoming" class="grid"></div>

      <details id="pastDetails" class="details-box">
        <summary>
          <span id="pastSummaryText">지난 업무 (0건) — 펼치기</span>
          <span class="details-hint">기본 접힘</span>
        </summary>

        <div style="margin-top:12px;">
          <div id="rootPast" class="grid"></div>

          <div class="more-row">
            <button id="morePastBtn" class="btn more" type="button" style="display:none;">
              더보기
            </button>
          </div>
        </div>
      </details>
    </section>

    <footer>
      제작·운영: 씩씩하고 귀여운 고주무관 · 질병코드 G47.4 기면병 및 탈력발작 · 너넨 기면증 없지? 메롱메롱
    </footer>
  </main>

  <script src="/static/disable-copy.js"></script>
  <script src="/static/global-loader.js?v=1"></script>

  <script>
    // =========================
    //  설정
    // =========================
    const TASKS_DIR = "/data/tasks/";
    const FILE_DAY = 3;
    const MAX_LOAD_MONTHS_AHEAD = 6;

    // 지난 업무 "더보기" 단위
    const PAST_PAGE_SIZE = 12;

    // =========================
    //  유틸
    // =========================
    const pad = n => (n < 10 ? "0" : "") + n;
    const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseYmd = (s) => {
      const [y,m,d] = (s||"").split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    };
    const addDays = (d,n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const addMonths = (d,n) => new Date(d.getFullYear(), d.getMonth()+n, 1);
    const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());

    function quarterStartKeyByDate(date){
      const y = date.getFullYear();
      const m = date.getMonth()+1;
      let qm = 1;
      if(m>=10) qm=10;
      else if(m>=7) qm=7;
      else if(m>=4) qm=4;
      else qm=1;
      return `${y}-${pad(qm)}-${pad(FILE_DAY)}`;
    }

    function collectQuarterKeys(baseDate, monthsAhead){
      const set = new Set();
      for(let i=0;i<=monthsAhead;i++){
        const d = addMonths(baseDate, i);
        set.add(quarterStartKeyByDate(d));
      }
      set.add(quarterStartKeyByDate(addMonths(baseDate, -3)));
      return [...set];
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function dueClass(diffDays){
      if(diffDays < 0) return "due-late";
      if(diffDays <= 1) return "due-danger";
      if(diffDays <= 7) return "due-warn";
      return "due-ok";
    }
    function dueLabel(diffDays){
      if(diffDays < 0) return `D+${Math.abs(diffDays)} (기한넘김)`;
      if(diffDays === 0) return "D-Day";
      return `D-${diffDays}`;
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function loadTasksForBase(baseDate){
      const keys = collectQuarterKeys(baseDate, MAX_LOAD_MONTHS_AHEAD);
      const urls = keys.map(k => `${TASKS_DIR}tasks-${k}.json`);

      const loaded = [];
      const okUrls = [];

      await Promise.all(urls.map(async (u)=>{
        try{
          const j = await fetchJson(u);
          const arr = Array.isArray(j.tasks) ? j.tasks : (Array.isArray(j) ? j : []);
          loaded.push(...arr);
          okUrls.push(u);
        }catch(e){
          // 없으면 스킵
        }
      }));

      return { tasks: loaded, urls: okUrls };
    }

    function makeTaskCard(t, base){
      const due = startOfDay(t._due);
      const diffDays = Math.round((due - base) / (1000*60*60*24));

      const title = escapeHtml(t.title || "(제목 없음)");
      const memo = escapeHtml(t.memo || t.desc || "");

      const chips = [];
      chips.push(`<span class="chip ${dueClass(diffDays)}">${dueLabel(diffDays)}</span>`);
      chips.push(`<span class="chip">마감: ${ymd(due)}</span>`);

      if(t.needBy)   chips.push(`<span class="chip">결재 필요: ${escapeHtml(t.needBy)}</span>`);
      if(t.approver) chips.push(`<span class="chip">결재권자: ${escapeHtml(t.approver)}</span>`);
      if(t.channel)  chips.push(`<span class="chip">경로: ${escapeHtml(t.channel)}</span>`);
      if(t.risk)     chips.push(`<span class="chip">리스크: ${escapeHtml(t.risk)}</span>`);

      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="card-head">
          <div class="title">${title}</div>
          <div class="meta">${chips.join("")}</div>
        </div>
        ${memo ? `<div class="desc white-pre">${memo}</div>` : ``}
      `;
      return el;
    }

    // =========================
    //  지난 업무 더보기 상태
    // =========================
    let pastAll = [];
    let pastShown = 0;
    let pastBase = null;

    function renderPastChunk(){
      const rootPast = document.getElementById("rootPast");
      const moreBtn = document.getElementById("morePastBtn");

      const next = Math.min(pastShown + PAST_PAGE_SIZE, pastAll.length);

      for(let i=pastShown; i<next; i++){
        rootPast.appendChild(makeTaskCard(pastAll[i], pastBase));
      }

      pastShown = next;

      if(pastShown < pastAll.length){
        moreBtn.style.display = "inline-block";
        moreBtn.textContent = `더보기 (${pastShown}/${pastAll.length})`;
      }else{
        moreBtn.style.display = "none";
      }
    }

    function render(tasks, baseDate, rangeDays){
      const rootUpcoming = document.getElementById("rootUpcoming");
      const rootPast = document.getElementById("rootPast");
      const pastDetails = document.getElementById("pastDetails");
      const pastSummaryText = document.getElementById("pastSummaryText");
      const moreBtn = document.getElementById("morePastBtn");

      rootUpcoming.innerHTML = "";
      rootPast.innerHTML = "";

      const base = startOfDay(baseDate);

      const lower = (rangeDays === 0) ? new Date(1970,0,1) : startOfDay(addDays(base, -rangeDays));
      const upper = (rangeDays === 0) ? new Date(2100,0,1) : startOfDay(addDays(base,  rangeDays));

      const filtered = (tasks||[])
        .map(t => ({ ...t, _due: parseYmd(t.due) }))
        .filter(t => t._due)
        .filter(t => {
          const dd = startOfDay(t._due);
          return dd >= lower && dd <= upper;
        });

      if(filtered.length === 0){
        rootUpcoming.innerHTML = `<div class="empty">없음. 자유를 누려라.</div>`;
        pastSummaryText.textContent = `지난 업무 (0건) — 펼치기`;
        pastDetails.open = false;
        moreBtn.style.display = "none";
        return;
      }

      const upcoming = [];
      const past = [];

      for(const t of filtered){
        const due = startOfDay(t._due);
        const diffDays = Math.round((due - base) / (1000*60*60*24));
        if(diffDays < 0) past.push(t);
        else upcoming.push(t);
      }

      // ✅ 당일/미래: 마감일 오름차순(빠른 것부터)
      upcoming.sort((a,b)=>{
        const ad = startOfDay(a._due);
        const bd = startOfDay(b._due);
        if(ad - bd !== 0) return ad - bd;
        return (a.title || "").localeCompare((b.title || ""), "ko");
      });

      // ✅ 지난 업무: "최근일수록 위" = 마감일 내림차순(늦은 날짜가 위)
      past.sort((a,b)=>{
        const ad = startOfDay(a._due);
        const bd = startOfDay(b._due);
        if(bd - ad !== 0) return bd - ad;
        return (a.title || "").localeCompare((b.title || ""), "ko");
      });

      // 렌더(당일/미래)
      if(upcoming.length === 0){
        rootUpcoming.innerHTML = `<div class="empty">당일~이후 마감 업무 없음.</div>`;
      }else{
        for(const t of upcoming){
          rootUpcoming.appendChild(makeTaskCard(t, base));
        }
      }

      // 지난 업무(접힘 + 더보기 초기화)
      pastSummaryText.textContent = `지난 업무 (${past.length}건) — 펼치기`;
      pastDetails.open = false;

      // 더보기 상태 세팅
      pastAll = past;
      pastShown = 0;
      pastBase = base;

      moreBtn.onclick = () => renderPastChunk();

      if(past.length === 0){
        rootPast.innerHTML = `<div class="empty">지난 업무 없음.</div>`;
        moreBtn.style.display = "none";
      }else{
        renderPastChunk(); // ✅ 처음 N개만
      }

      // summary 문구 토글
      pastDetails.addEventListener("toggle", ()=>{
        const tail = pastDetails.open ? "접기" : "펼치기";
        pastSummaryText.textContent = `지난 업무 (${past.length}건) — ${tail}`;
      }, { once:false });
    }

    const baseLabel = document.getElementById("baseLabel");
    const filesLabel = document.getElementById("filesLabel");
    const baseDateInput = document.getElementById("baseDateInput");
    const rangeSel = document.getElementById("rangeSel");
    const reloadBtn = document.getElementById("reloadBtn");

    function setUiBaseDate(d){
      baseDateInput.value = ymd(d);
      baseLabel.textContent = ymd(d);
    }

    async function refresh(){
      const base = parseYmd(baseDateInput.value) || new Date();
      const rangeDays = parseInt(rangeSel.value, 10) || 7;

      baseLabel.textContent = ymd(base);

      const { tasks, urls } = await loadTasksForBase(base);
      filesLabel.textContent = urls.length ? urls.map(u => u.replace(TASKS_DIR,"")).join(", ") : "(없음)";

      render(tasks, startOfDay(base), rangeDays);
    }

    setUiBaseDate(new Date());

    reloadBtn.addEventListener("click", refresh);
    baseDateInput.addEventListener("change", refresh);
    rangeSel.addEventListener("change", refresh);

    refresh();
  </script>
</body>
</html>
