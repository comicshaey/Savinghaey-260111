<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>마감 임박 업무 목록</title>

  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    :root{
      --line:#e5e5e5;
      --muted:#666;
      --chip:#f3f4f6;
      --danger:#c8352d;
      --warn:#b45309;
      --ok:#0f766e;
      --late:#7c3aed;
    }

    .wrap{max-width:880px; margin:0 auto; padding:24px 16px;}
    h1{font-size:1.75rem; margin:18px 0 8px; text-align:left !important;}
    .subtitle{margin:0 0 12px; color:#444; font-size:0.98rem}
    .muted{color:var(--muted); font-size:0.95rem}
    hr{border:none; border-top:1px solid #ddd; margin:20px 0;}

    .section{
      border:1px solid var(--line);
      border-radius:12px;
      padding:16px 18px;
      margin:18px 0;
      background:#fff;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .topbar .left{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid #e6e6e6;
      font-size:0.9rem;
      color:#333;
    }
    .pill b{color:#111}

    .btn{
      display:inline-block;
      padding:10px 16px;
      border-radius:12px;
      border:1px solid #222;
      text-decoration:none;
      color:#111;
      font-weight:600;
      background:#fff;
    }
    .btn:hover{background:#f3f4f6;}
    .btn.primary{background:#111; color:#fff;}
    .btn.primary:hover{background݈:#000;}
    .btn + .btn{margin-left:8px;}

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    .controls input[type="date"]{min-width:160px;}
    .controls select{min-width:160px;}

    .grid{
      display:grid;
      gap:12px;
      margin-top:12px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px 14px 12px;
      background:#fafafa;
    }

    /* =============================
       Dashboard hotfix (공통CSS 충돌 방지)
       ============================= */

    /* 카드 헤더: 무조건 세로 (타이틀 위 / 칩 아래) */
    .card-head{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      gap:10px;
      margin-bottom:8px;
    }

    /* 타이틀은 한 줄 영역을 확실히 확보 */
    .title{
      width:100%;
      font-weight:800;
      color:#111;
      font-size:1.05rem;
      line-height:1.35;
    }

    /* 칩 묶음: 왼쪽정렬 + 자연 줄바꿈 + 전체폭 */
    .meta{
      width:100%;
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-start !important;
      align-items:flex-start;
      gap:6px;
    }

    /* 칩: 공통CSS(body span) 영향 차단 */
    .chip{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e6e6e6;
      font-size:0.85rem !important;
      line-height:1.2 !important;
      color:#333;
      white-space:normal;
      max-width:100%;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    /* 모바일에서 칩이 타이틀 옆에 억지로 붙는 느낌 방지 */
    @media (max-width: 640px){
      .chip{ flex: 0 1 auto; }
    }

    .chip.due-danger{border-color:rgba(200,53,45,.35); color:var(--danger); font-weight:800;}
    .chip.due-warn{border-color:rgba(180,83,9,.35); color:var(--warn); font-weight:800;}
    .chip.due-ok{border-color:rgba(15,118,110,.35); color:var(--ok); font-weight:800;}
    .chip.due-late{border-color:rgba(124,58,237,.35); color:var(--late); font-weight:800;}

    /* 메모 줄바꿈 유지 */
    .white-pre{
      white-space: pre-wrap;
      overflow-wrap:anywhere;
      line-height:1.5;
    }

    .desc{
      margin-top:6px;
      color:#333;
      font-size:0.95rem;
    }

    .empty{
      padding:14px;
      border:1px dashed #d7d7d7;
      border-radius:12px;
      background:#fff;
      color:#666;
      font-size:0.95rem;
    }

    footer{
      margin:18px 0 8px;
      color:#555;
      font-size:.9rem;
      text-align:center;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <h1>마감임박 업무 알림</h1>
    <p class="subtitle">·마감 넘긴 것도 같이 조회</p>

    <div class="topbar">
      <div class="left">
        <span class="pill">기준 일자: <b id="baseLabel">-</b></span>
        <span class="pill">파일 로딩: <b id="filesLabel">-</b></span>
      </div>
      <div>
        <a class="btn" href="/">메인으로 돌아가기</a>
        <a class="btn" href="/calendar/">달력 보기</a>
      </div>
    </div>

    <div class="section">
      <div class="controls">
        <label class="muted">기준 일자:
          <input type="date" id="baseDateInput" />
        </label>

        <label class="muted">조회 범위:
          <select id="rangeSel">
            <option value="0">전체보기</option>
            <option value="1">당일</option>
            <option value="7" selected>7일</option>
            <option value="14">14일</option>
          </select>
        </label>

        <button class="btn primary" id="reloadBtn" type="button">조회하기</button>
      </div>
      <p class="muted" style="margin:10px 0 0;">
        기준일자 전후로 보여줌
      </p>
    </div>

    <section class="section">
      <h2 style="font-size:1.2rem; margin:0 0 12px">마감 임박 업무 목록</h2>
      <hr />
      <div id="root" class="grid"></div>
    </section>

    <footer>
      제작·운영: 씩씩하고 귀여운 고주무관 · 질병코드 G47.4 기면병 및 탈력발작 · 너넨 기면증 없지? 메롱메롱
    </footer>
  </main>

  <script src="/static/disable-copy.js"></script>
  <script src="/static/global-loader.js?v=1"></script>

  <script>
    // =========================
    //  설정
    // =========================
    const TASKS_DIR = "/data/tasks/";
    const FILE_DAY = 3;
    const MAX_LOAD_MONTHS_AHEAD = 6;

    // =========================
    //  유틸
    // =========================
    const pad = n => (n < 10 ? "0" : "") + n;
    const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseYmd = (s) => {
      const [y,m,d] = (s||"").split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    };
    const addDays = (d,n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const addMonths = (d,n) => new Date(d.getFullYear(), d.getMonth()+n, 1);
    const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());

    function quarterStartKeyByDate(date){
      const y = date.getFullYear();
      const m = date.getMonth()+1;
      let qm = 1;
      if(m>=10) qm=10;
      else if(m>=7) qm=7;
      else if(m>=4) qm=4;
      else qm=1;
      return `${y}-${pad(qm)}-${pad(FILE_DAY)}`;
    }

    function collectQuarterKeys(baseDate, monthsAhead){
      const set = new Set();
      for(let i=0;i<=monthsAhead;i++){
        const d = addMonths(baseDate, i);
        set.add(quarterStartKeyByDate(d));
      }
      set.add(quarterStartKeyByDate(addMonths(baseDate, -3)));
      return [...set];
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function dueClass(diffDays){
      if(diffDays < 0) return "due-late";
      if(diffDays <= 1) return "due-danger";
      if(diffDays <= 7) return "due-warn";
      return "due-ok";
    }
    function dueLabel(diffDays){
      if(diffDays < 0) return `D+${Math.abs(diffDays)} (기한넘김)`;
      if(diffDays === 0) return "D-Day";
      return `D-${diffDays}`;
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function loadTasksForBase(baseDate){
      const keys = collectQuarterKeys(baseDate, MAX_LOAD_MONTHS_AHEAD);
      const urls = keys.map(k => `${TASKS_DIR}tasks-${k}.json`);

      const loaded = [];
      const okUrls = [];

      await Promise.all(urls.map(async (u)=>{
        try{
          const j = await fetchJson(u);
          const arr = Array.isArray(j.tasks) ? j.tasks : (Array.isArray(j) ? j : []);
          loaded.push(...arr);
          okUrls.push(u);
        }catch(e){
          // 없으면 스킵
        }
      }));

      return { tasks: loaded, urls: okUrls };
    }

    function render(tasks, baseDate, rangeDays){
      const root = document.getElementById("root");
      root.innerHTML = "";

      const base = startOfDay(baseDate);

      // rangeDays=0이면 "전체보기"라면서 사실상 기준일만 보여주는 게 애매해서:
      // 전체보기 = 모든 due를 보여주되, 정렬만 기준일 기반으로 한다는 식으로 가려면 아래 로직 바꿔야 함.
      // 네가 의도한 게 "전후 N일"이면 지금 로직 유지.
      const lower = (rangeDays === 0) ? new Date(1970,0,1) : startOfDay(addDays(base, -rangeDays));
      const upper = (rangeDays === 0) ? new Date(2100,0,1) : startOfDay(addDays(base,  rangeDays));

      const filtered = (tasks||[])
        .map(t => ({ ...t, _due: parseYmd(t.due) }))
        .filter(t => t._due)
        .filter(t => {
          const dd = startOfDay(t._due);
          return dd >= lower && dd <= upper;
        })
        .sort((a,b)=> startOfDay(a._due) - startOfDay(b._due));

      if(filtered.length === 0){
        root.innerHTML = `<div class="empty">없음. 자유를 누려라.</div>`;
        return;
      }

      for(const t of filtered){
        const due = startOfDay(t._due);
        const diffDays = Math.round((due - base) / (1000*60*60*24));

        const title = escapeHtml(t.title || "(제목 없음)");
        const memo = escapeHtml(t.memo || t.desc || "");

        const chips = [];
        chips.push(`<span class="chip ${dueClass(diffDays)}">${dueLabel(diffDays)}</span>`);
        chips.push(`<span class="chip">마감: ${ymd(due)}</span>`);

        if(t.needBy)   chips.push(`<span class="chip">결재 필요: ${escapeHtml(t.needBy)}</span>`);
        if(t.approver) chips.push(`<span class="chip">결재권자: ${escapeHtml(t.approver)}</span>`);
        if(t.channel)  chips.push(`<span class="chip">경로: ${escapeHtml(t.channel)}</span>`);
        if(t.risk)     chips.push(`<span class="chip">리스크: ${escapeHtml(t.risk)}</span>`);

        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="card-head">
            <div class="title">${title}</div>
            <div class="meta">${chips.join("")}</div>
          </div>
          ${memo ? `<div class="desc white-pre">${memo}</div>` : ``}
        `;
        root.appendChild(el);
      }
    }

    const baseLabel = document.getElementById("baseLabel");
    const filesLabel = document.getElementById("filesLabel");
    const baseDateInput = document.getElementById("baseDateInput");
    const rangeSel = document.getElementById("rangeSel");
    const reloadBtn = document.getElementById("reloadBtn");

    function setUiBaseDate(d){
      baseDateInput.value = ymd(d);
      baseLabel.textContent = ymd(d);
    }

    async function refresh(){
      const base = parseYmd(baseDateInput.value) || new Date();
      const rangeDays = parseInt(rangeSel.value, 10) || 7;

      baseLabel.textContent = ymd(base);

      const { tasks, urls } = await loadTasksForBase(base);
      filesLabel.textContent = urls.length ? urls.map(u => u.replace(TASKS_DIR,"")).join(", ") : "(없음)";

      render(tasks, startOfDay(base), rangeDays);
    }

    setUiBaseDate(new Date());

    reloadBtn.addEventListener("click", refresh);
    baseDateInput.addEventListener("change", refresh);
    rangeSel.addEventListener("change", refresh);

    refresh();
  </script>
</body>
</html>
